## MySQL大版本升级

### 操作场景

MySQL云数据库支持通过控制台手动升级大版本

支持MySQL5.6 升级到MySQL5.7

支持MySQL5.7升级到MySQL8.0

### 功能限制

#### 实例限制

* 仅支持NVMe高可用实例，SSD云盘高可用实例。

* 实例如果有多个只读实例，只读实例会一起进行升级，只读实例个数不能超过5个， 否则预检查会失败。

* 升级大版本需要做预检查，请确保实例是运行状态。预检查会进行资源检查、实例基础信息检查、实例参数检查、实例兼容性检查。预检查结果有效期为24小时， 超时或者对DB进行过操作(如重启)， 需要重新进行预检查。

* 升级操作需要设置目标版本的配置文件 

#### 升级限制

* 不支持跨大版本升级，例如MySQL5.6直接升级到MySQL8.0

* 升级后不支持降级

* 升级完成后，旧版本的备份文件将无法使用

#### 数据库限制

* 对于MySQL5.7升级到MySQL8.0，如果目标配置文件sql_mode没有设置， 升级后将去除MySQL8.0不支持的设置， 如果目标配置文件设置了sql_mode参数，预检查将对sql_mode参数进行一致性检查。

* 如果实例存在非事务引擎表， 将不支持大版本升级。

* 对于MySQL5.7升级到MySQL8.0，如果数据库实例中存在 MySQL8.0预留关键字的表、视图、存储过程、触发器等会导致预检查失败。

* 对于MySQL5.7升级到MySQL8.0，数据库中的存储过程、触发器、视图或函数中若包含 [Changes in MySQL8.0](https://dev.mysql.com/doc/refman/8.0/en/upgrading-from-previous-series.html)，则会导致预检查失败

* 如果实例中数据表数量超过20万张，则不支持升级，请在升级前清理冗余表。

### 升级前准备

* 由于MySQL大版本之间差异较大， 建议控制台从备份创建一个新实例进行升级，升级完成后进行业务测试，测试正常后再进行生产数据库版本升级。

* 大版本升级前建议仔细对比版本间的差异

* 大版本升级前建议进行一次全量备份

* 大版本升级涉及数据搬迁，具体耗时跟实例数据量大小有关

* 大版本升级期间不能进行数据库操作， 但可以取消升级操作

* 在大版本升级过程中， 会有VIP的切换操作， 请设置切换时间窗口或者选择数据同步完成后立即切换， 切换时MySQL服务会出现闪断，请确保业务有自动重连机制。

### 操作步骤

升级MySQL大版本，会先进行实例预检查，预检查成功后， 可以进行大版本升级。大版本升级会先进行数据准备， 数据准备完成并且同步关系正常后，到达切换窗口进行版本切换。

**列表页**

点击升级大版本

![image](/images/upgrade_major_version_list_table.png)

**升级预检查**

MySQL升级大版本会先进行预检查， 预检查需要选择目标版本和版本对应的参数模板，MySQL升级大版本预检查操作异步进行

![image](/images/upgrade_major_version_precheck.png)

**获取预检查结果**

![image](/images/upgrade_major_version_precheck_result.png)

**取消升级**

MySQL升级大版本在数据准备期间可以进行取消升级操作，待切换状态不支持取消升级

![image](/images/upgrade_major_version_stop.png)

**修改切换时间**

在升级的过程中可以进行切换时间的修改

![image](/images/upgrade_major_version_change_time_1.png)
![image](/images/upgrade_major_version_change_time_2.png)
